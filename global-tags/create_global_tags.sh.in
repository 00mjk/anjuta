#!/bin/sh

PKG_CONFIG=`which pkg-config 2>/dev/null`
if [ "x$PKG_CONFIG" = x -o ! -x "$PKG_CONFIG" ]
then
    echo "Can not find or execute pkg-config" >&2
    exit 1
fi

ANJUTA_TAGS="@scriptdir@/anjuta-tags"
if [ ! -x "$ANJUTA_TAGS" ]
then
    echo "Can not execute $ANJUTA_TAGS" >&2
    exit 1
fi

echo "[...........................................................................]"
echo "[. Generating System tags. This may take several minutes (1 min to 20 mins).]"
echo "[. You can go out, have a coffee and return back in 20 mins. ...............]"
echo "[...........................................................................]"

ANJUTA_DIR="$HOME/.anjuta"
if [ ! -d "$ANJUTA_DIR/tags" ]
then
    mkdir -p "$ANJUTA_DIR/tags"
    if [ ! -d "$ANJUTA_DIR/tags" ]
    then
        echo "Can not create $ANJUTA_DIR/tags" >&2
        exit 1
    fi
fi

verbose=no
for package in `"$PKG_CONFIG" --list-all|cut -f1 '-d '` ;
do
    cflags=`"$PKG_CONFIG" --cflags "$package" 2>/dev/null`
    tag_file="$ANJUTA_DIR/tags/$package.anjutatags"
    echo "  . Creating tags file: $package.anjutatags.gz ..."

    FILES=""
    for cflag in $cflags ;
    do
        case "$cflag" in
            -I/usr/include)
            ;;
            -I/usr/local/include)
            ;;
            -I*)
                include=`echo "$cflag"|sed 's/^-I//'`
                if [ -d "$include" ]
                then
                    files=`find "$include" -name '*.h'`
                    if [ "x$files" != x ]
                    then
                        if [ "x$FILES" != x ]
                        then
                            FILES="$FILES $files"
                        else
                            FILES="$files"
                        fi
                    fi
                fi
            ;;
            *)
            ;;
        esac
    done

    rm -f "$tag_file" "$tag_file.gz"
    if [ "x$FILES" != x ]
    then
        if [ "x$verbose" = xyes ]
        then
            FILES_COUNT=`echo "$FILES"|wc -w`
            echo "    . Creating $tag_file"
            echo "    . Number of files to scan: $FILES_COUNT"
            echo "    . Files to scan: $FILES"
        fi

        CTAGS="$ctags" "$ANJUTA_TAGS" "$tag_file" $FILES 2>/dev/null
        if [ ! -e "$tag_file" ]
        then
            echo "  WARNING: Could not create tags file: $tag_file" >&2
        else
            gzip -f "$tag_file"
        fi
    fi
done
echo "This is just a timestamp" > "$ANJUTA_DIR/system-tags.cache"
